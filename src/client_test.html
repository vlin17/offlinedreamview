<html>
<head>
<script>
// const WebSocket = require('ws');


const ws = new WebSocket('ws://localhost:8888/websocket');

// ws.on('open', function open() {
//   console.log('connected');
//   ws.send(Date.now());
// });

// ws.on('close', function close() {
//   console.log('disconnected');
// });

// ws.on('message', function incoming(data) {
//   console.log(`Roundtrip time: ${Date.now() - data} ms`);

//   setTimeout(function timeout() {
//     ws.send(Date.now());
//   }, 500);
// });



class WebSocketEndpoint {
    constructor(serverAddr) {
        this.serverAddr = serverAddr;
        this.websocket = null;
    }

    initialize() {
        try {
            this.websocket = new WebSocket(this.serverAddr);
        } catch (error) {
            console.error("Failed to establish a connection: " + error);
            setTimeout(() => {
                this.initialize();
            }, 1000);
            return;
        }
        this.websocket.onopen = () => {
        	const clientId = Math.floor(Math.random()*100).toString();
		  console.log('connected as ', clientId);
		  this.websocket.send(JSON.stringify({
		  	type: 'FrameData',
		  	data: {
			  	mapId: '5966226f8cd6963204b73649',
			  	view: 'worldsim',
			  	id: '0017',
			  	clientId: clientId,
			  }
		  }));
		};

        this.websocket.onmessage = event => {
			// console.log(`Roundtrip time: ${Date.now() - event.data} ms`);
			console.log("got data:", event.data);
        };

        this.websocket.onclose = event => {
            console.log("WebSocket connection closed, close_code: " + event.code);
            this.initialize();
        };
    }
}

// Returns the websocket server address based on the web server address.
// Follows the convention that the websocket is served on the same host
// as the web server, the port number of websocket is the port number of
// the webserver plus one.
function deduceWebsocketServerAddr() {
    const server = window.location.origin;
    const link = document.createElement("a");
    link.href = server;
    const protocol = location.protocol === "https:" ? "wss" : "ws";
    return `${protocol}://${link.hostname}:${window.location.port}/websocket`;
}

// NOTE: process.env.NODE_ENV will be set to "production" by webpack when
// invoked in production mode ("-p"). We rely on this to determine which
// websocket server to use.
const serverAddr = `ws://localhost:8888/websocket`;
const WS = new WebSocketEndpoint(serverAddr);
WS.initialize();

</script>
</head>
</html>